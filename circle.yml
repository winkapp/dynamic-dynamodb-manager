machine:
  services:
    - docker
    - redis
  ruby:
    version: 2.2.4

dependencies:
  pre:
    - curl --create-dirs -Lv -o DynamoDBLocal/dynamodb_local_latest.tar.gz http://dynamodb-local.s3-website-us-west-2.amazonaws.com/dynamodb_local_latest.tar.gz
    - tar -zxvf DynamoDBLocal/dynamodb_local_latest.tar.gz -C DynamoDBLocal

test:
  pre:
    - java -Djava.library.path=DynamoDBLocal/DynamoDBLocal_lib -jar DynamoDBLocal/DynamoDBLocal.jar -port 4567:
        background: true

deployment:
  docker:
    branch: [master, staging, production]
    commands:
      - docker login -e $QUAY_EMAIL -u $QUAY_USER -p $QUAY_PASS quay.io
      - docker build -t quay.io/winkapp/dynamic-dynamodb-manager:$CIRCLE_SHA1 .
      - docker tag -f quay.io/winkapp/dynamic-dynamodb-manager:$CIRCLE_SHA1 quay.io/winkapp/dynamic-dynamodb-manager:$CIRCLE_BRANCH
      - docker push quay.io/winkapp/dynamic-dynamodb-manager
